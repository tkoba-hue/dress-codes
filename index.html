<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DRESS CODEs</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    
    const firebaseConfig = {
      apiKey: "AIzaSyClI3Oyp-vg3S46CVzukYeysUuMUjIf8Lk",
      authDomain: "dress-codes-party.firebaseapp.com",
      projectId: "dress-codes-party",
      storageBucket: "dress-codes-party.firebasestorage.app",
      messagingSenderId: "914618482726",
      appId: "1:914618482726:web:a13f2fbc01824df027a6e7"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
    window.firebaseDb = db;
    window.firebaseCollection = collection;
    window.firebaseAddDoc = addDoc;
    window.firebaseGetDocs = getDocs;
    window.firebaseQuery = query;
    window.firebaseWhere = where;
  </script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400&family=Crimson+Text:wght@400;600&display=swap');
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      font-weight: 200;
    }
    
    .serif {
      font-family: 'Crimson Text', serif;
    }
    
    @keyframes breathe {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }
    
    @keyframes line-grow {
      from { transform: scaleX(0); }
      to { transform: scaleX(1); }
    }
    
    @keyframes fade-in {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .animate-breathe {
      animation: breathe 6s ease-in-out infinite;
    }
    
    .animate-line-grow {
      animation: line-grow 1.2s ease-out forwards;
      transform-origin: left;
    }
    
    .animate-fade-in {
      animation: fade-in 0.8s ease-out forwards;
      opacity: 0;
    }
    
    .card {
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 40px rgba(255, 255, 255, 0.1);
    }
    
    .card-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
    }
  </style>
</head>
<body class="bg-black text-white min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const DressCodes = () => {
      const [step, setStep] = useState('input');
      const [partyInfo, setPartyInfo] = useState({
        ageGroup: '',
        userGender: '',
        location: '',
        atmosphere: '',
        attendees: '',
        budget: ''
      });
      const [proposals, setProposals] = useState(null);
      const [selectedProposal, setSelectedProposal] = useState(null);
      const [personalInfo, setPersonalInfo] = useState({
        gender: '',
        ageGroup: '',
        budget: ''
      });
      const [outfit, setOutfit] = useState(null);
      const [loading, setLoading] = useState(false);
      const [proposalHistory, setProposalHistory] = useState([]);
      const [okList, setOkList] = useState([]);
      const [showRatingModal, setShowRatingModal] = useState(false);
      const [currentRating, setCurrentRating] = useState(0);
      const [currentComment, setCurrentComment] = useState('');
      const [selectedOkEntry, setSelectedOkEntry] = useState(null);

      // OKãƒªã‚¹ãƒˆã‚’Firestoreã‹ã‚‰å–å¾—
      useEffect(() => {
        const loadOkList = async () => {
          try {
            const ratingsSnapshot = await window.firebaseGetDocs(
              window.firebaseCollection(window.firebaseDb, 'ratings')
            );
            
            const allRatings = [];
            ratingsSnapshot.forEach(doc => {
              const data = doc.data();
              allRatings.push({
                id: doc.id,
                dressCode: data.dressCode || '',
                imageUrl: data.imageUrl || 'https://images.pexels.com/photos/1040945/pexels-photo-1040945.jpeg',
                rating: data.rating || 0,
                comment: data.comment || '',
                outfit: data.outfit || '',
                timestamp: data.timestamp || new Date().toISOString()
              });
            });
            
            // æ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆ
            allRatings.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            setOkList(allRatings);
          } catch (error) {
            console.error('OKãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          }
        };
        
        loadOkList();
      }, []);

      const reset = () => {
        setStep('input');
        setPartyInfo({
          ageGroup: '',
          userGender: '',
          location: '',
          atmosphere: '',
          attendees: '',
          budget: ''
        });
        setProposals(null);
        setSelectedProposal(null);
        setPersonalInfo({ gender: '', ageGroup: '', budget: '' });
        setOutfit(null);
        setProposalHistory([]);
      };

      const handleInputChange = (field, value) => {
        setPartyInfo(prev => ({ ...prev, [field]: value }));
      };
      
      const handleOkClick = () => {
        setShowRatingModal(true);
      };
      
      const handleSaveRating = async () => {
        if (currentRating === 0) {
          alert('è©•ä¾¡ã‚’é¸æŠã—ã¦ãã ã•ã„');
          return;
        }
        
        const newEntry = {
          dressCode: selectedProposal.title,
          imageUrl: selectedProposal.imageUrl,
          rating: currentRating,
          comment: currentComment,
          outfit: outfit.content,
          timestamp: new Date().toISOString(),
          category: selectedProposal.category || 'unknown'
        };
        
        // Firestoreã«ä¿å­˜
        try {
          await window.firebaseAddDoc(window.firebaseCollection(window.firebaseDb, 'ratings'), newEntry);
          
          // ä¿å­˜å¾Œã€ãƒªã‚¹ãƒˆã‚’ãƒªãƒ­ãƒ¼ãƒ‰
          const ratingsSnapshot = await window.firebaseGetDocs(
            window.firebaseCollection(window.firebaseDb, 'ratings')
          );
          
          const allRatings = [];
          ratingsSnapshot.forEach(doc => {
            const data = doc.data();
            allRatings.push({
              id: doc.id,
              ...data
            });
          });
          
          allRatings.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          setOkList(allRatings);
          
        } catch (error) {
          console.error('Firebaseä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        }
        
        setShowRatingModal(false);
        setCurrentRating(0);
        setCurrentComment('');
        
        alert('é¸ã°ã‚ŒãŸææ¡ˆã«è¿½åŠ ã—ã¾ã—ãŸï¼');
      };

      const generateProposals = async () => {
        setLoading(true);
        
        // Firebaseã‹ã‚‰çµ±è¨ˆã‚’å–å¾—ã—ã¦ã‚«ãƒ†ã‚´ãƒªã®é‡ã¿ä»˜ã‘ã‚’è¨ˆç®—
        let categoryWeights = {};
        try {
          const ratingsSnapshot = await window.firebaseGetDocs(
            window.firebaseCollection(window.firebaseDb, 'ratings')
          );
          
          const categoryRatings = {};
          const categoryCounts = {};
          
          ratingsSnapshot.forEach(doc => {
            const data = doc.data();
            const category = data.category || 'unknown';
            const rating = data.rating || 0;
            
            if (!categoryRatings[category]) {
              categoryRatings[category] = 0;
              categoryCounts[category] = 0;
            }
            
            categoryRatings[category] += rating;
            categoryCounts[category] += 1;
          });
          
          // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®å¹³å‡è©•ä¾¡ã‚’è¨ˆç®—
          for (const category in categoryRatings) {
            const avgRating = categoryRatings[category] / categoryCounts[category];
            // è©•ä¾¡ãŒé«˜ã„ã»ã©é¸ã°ã‚Œã‚„ã™ãã™ã‚‹ï¼ˆ0.5ã€œ1.5ã®ç¯„å›²ï¼‰
            categoryWeights[category] = 0.5 + (avgRating / 5);
          }
          
          console.log('ã‚«ãƒ†ã‚´ãƒªé‡ã¿:', categoryWeights);
        } catch (error) {
          console.error('Firebaseçµ±è¨ˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        }
        
        // ã‚«ãƒ†ã‚´ãƒªã‚’ãƒ©ãƒ³ãƒ€ãƒ é¸æŠï¼ˆé‡è¤‡å›é¿ãƒ­ã‚¸ãƒƒã‚¯ä»˜ãï¼‰
        const allCategories = {
          formal: [
            'æ­£çµ±æ´¾ãƒ•ã‚©ãƒ¼ãƒãƒ«ç³»ï¼ˆä¾‹: ãƒ›ãƒ¯ã‚¤ãƒˆã‚¿ã‚¤ã€ãƒ–ãƒ©ãƒƒã‚¯ã‚¿ã‚¤ã€ã‚»ãƒŸãƒ•ã‚©ãƒ¼ãƒãƒ«ï¼‰',
            'ã‚¹ãƒãƒ¼ãƒˆã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ç³»ï¼ˆä¾‹: ã‚¸ãƒ£ã‚±ãƒƒãƒˆå¿…é ˆã€ã‚¨ãƒ¬ã‚¬ãƒ³ãƒˆã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ï¼‰'
          ],
          kimono: [
            'å’Œè£…ç³»ï¼ˆä¾‹: æŒ¯è¢–ã€è¨ªå•ç€ã€ç´‹ä»˜è¢´ã€æµ´è¡£ã‚¢ãƒ¬ãƒ³ã‚¸ï¼‰',
            'ç€ç‰©ãƒ¢ãƒ€ãƒ³ã‚¢ãƒ¬ãƒ³ã‚¸ç³»ï¼ˆä¾‹: ç€ç‰©Ã—æ´‹æœãƒŸãƒƒã‚¯ã‚¹ã€ç¾½ç¹”æ´»ç”¨ï¼‰'
          ],
          historical: [
            'æ­´å²ãƒ»æ–‡åŒ–ç³»ï¼ˆæ™‚ä»£ãƒ»åœ°åŸŸãƒ»éšç´šã‚’å…·ä½“çš„ã«ã€‚ä¾‹: 18ä¸–ç´€ãƒ•ãƒ©ãƒ³ã‚¹é©å‘½æœŸã®å¸‚æ°‘ã‚¹ã‚¿ã‚¤ãƒ«ã€è–©æ‘©è—©ã®ç¤ºç¾æµå‰£å£«ï¼‰',
            'ã‚¢ãƒ•ãƒªã‚«ãƒ³ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³ç³»ï¼ˆä¾‹: ã‚¢ãƒ•ãƒ­ãƒ»ãƒ•ãƒ¥ãƒ¼ãƒãƒ£ãƒªã‚ºãƒ ã€ã‚¢ãƒ³ã‚«ãƒ©æŸ„ã€ã‚±ãƒ³ãƒ†å¸ƒï¼‰'
          ],
          è·æ¥­: [
            'ãƒ¯ãƒ³ãƒã‚¤ãƒ³ãƒˆè·æ¥­ç³»ï¼ˆè·æ¥­å…¨ä½“ã®é›°å›²æ°—ã€‚ä¾‹: ã‚¹ãƒ‘ã‚¤é¢¨ã€åŸ·äº‹é¢¨ã€ç§‘å­¦è€…é¢¨ï¼‰',
          ],
          character: [
            'ãƒ¯ãƒ³ãƒã‚¤ãƒ³ãƒˆã‚­ãƒ£ãƒ©ç³»ï¼ˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å…¨ä½“ã®é›°å›²æ°—ã€‚ä¾‹: æµ·è³Šé¢¨ã€é­”æ³•ä½¿ã„é¢¨ï¼‰',
          ],
          situation: [
            'çŠ¶æ…‹ãƒ»çŠ¶æ³ç³»ï¼ˆä»Šã©ã‚“ãªçŠ¶æ…‹ã®äººã‹ã€‚ä¾‹: 3æ—¥å¾¹å¤œæ˜ã‘ã€å®ãã˜å½“é¸ç›´å¾Œï¼‰',
            'å‹˜é•ã„ãƒ»èª¤è§£ç³»ï¼ˆä½•ã‹ã‚’å‹˜é•ã„ã—ã¦ã„ã‚‹è¨­å®šã€‚ä¾‹: å¯Œè±ªã ã¨æ€ã„è¾¼ã‚“ã§ã„ã‚‹äººï¼‰',
            'ä¸–ç•Œä¸€ã€‡ã€‡ç³»ï¼ˆãã‚Œãã‚ŒãŒæ€ã†ä¸–ç•Œä¸€ã®äººã€‚ä¾‹: ä¸–ç•Œä¸€å¿™ã—ã„äººï¼‰'
          ],
          rule: [
            'è‰²æŒ‡å®šç³»ï¼ˆå…¨èº«1è‰²ã€ã¾ãŸã¯ç‰¹å®šè‰²ç¦æ­¢ã€‚ä¾‹: å…¨èº«èµ¤ã€é’ç¦æ­¢ï¼‰',
            'ã‚µã‚¤ã‚ºæ„Ÿé•åç³»ï¼ˆå¤§ãã™ã/å°ã•ã™ãã€‚ä¾‹: å­ä¾›æœã‚µã‚¤ã‚ºã«ç„¡ç†ã‚„ã‚Šï¼‰',
            'å¤©å€™é•åç³»ï¼ˆå­£ç¯€å¤–ã‚Œã®è£…ã„ã€‚ä¾‹: çœŸå¤ã«çœŸå†¬è£…å‚™ï¼‰'
          ],
          creative: [
            'æ¶ç©ºå‰µä½œç³»ï¼ˆå­˜åœ¨ã—ãªã„å›½ã®æ°‘æ—è¡£è£…ãªã©ã€‚ä¾‹: æ¶ç©ºã®å—ã®å³¶ã®æ°‘æ—è¡£è£…ï¼‰',
            'TPOç„¡è¦–ç³»ï¼ˆå ´æ‰€ã«å…¨ãåˆã‚ãªã„è£…ã„ã€‚ä¾‹: ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãªã®ã«ãƒ”ã‚¯ãƒ‹ãƒƒã‚¯è£…å‚™ï¼‰',
            'ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¬ãƒ³ãƒ‰ç³»ï¼ˆä¾‹: Y2Kã€ã‚´ãƒ¼ãƒ—ã‚³ã‚¢ã€ã‚µã‚¹ãƒ†ãƒŠãƒ–ãƒ«ãƒ»ãƒ©ã‚°ã‚¸ãƒ¥ã‚¢ãƒªãƒ¼ï¼‰'
          ]
        };
        
        // ç•°ãªã‚‹ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰3ã¤é¸æŠï¼ˆé‡ã¿ä»˜ããƒ»é‡è¤‡å›é¿ï¼‰
        const categoryKeys = Object.keys(allCategories);
        
        // é‡ã¿ä»˜ããƒ©ãƒ³ãƒ€ãƒ é¸æŠ
        const weightedShuffle = (keys) => {
          return keys.sort((a, b) => {
            const weightA = categoryWeights[a] || 1.0;
            const weightB = categoryWeights[b] || 1.0;
            return (Math.random() * weightB) - (Math.random() * weightA);
          });
        };
        
        const shuffledKeys = weightedShuffle([...categoryKeys]);
        const selectedCategoriesWithKeys = shuffledKeys.slice(0, 3).map(key => {
          const items = allCategories[key];
          return {
            key: key,
            template: items[Math.floor(Math.random() * items.length)]
          };
        });
        const selectedCategories = selectedCategoriesWithKeys.map(c => c.template);
        
        const systemPrompt = `ã‚ãªãŸã¯é«˜ç´šãƒ†ãƒ¼ãƒ©ãƒ¼ï¼ˆä»•ç«‹å±‹ï¼‰ã®åº—ä¸»ã§ã™ã€‚
ä¸å¯§ã§çœŸé¢ç›®ãªå£èª¿ã§ã€ãŠå®¢æ§˜ã®ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ã«ç›¸å¿œã—ã„ãƒ‰ãƒ¬ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚

ã€çµ¶å¯¾ç¦æ­¢ã€‘
- ä¸‹ç€ã‚’å¤–ã«ç€ã‚‹ææ¡ˆ
- éåº¦ãªéœ²å‡º
- ä¸è¬¹æ…ãªã‚‚ã®ï¼ˆå–ªæœã€å›šäººæœãªã©ï¼‰
- å…¬åºè‰¯ä¿—ã«åã™ã‚‹ã‚‚ã®
- ç‰¹å®šã®å›½ã‚„å›£ä½“ã®åˆ¶æœãƒ»è»æœ`;

        const partyInfoText = `ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼æƒ…å ±:
å¹´ä»£: ${partyInfo.ageGroup || 'æœªå®š'}
å ´æ‰€: ${partyInfo.location || 'æœªå®š'}
é›°å›²æ°—: ${partyInfo.atmosphere || 'æœªå®š'}
å‚åŠ äººæ•°: ${partyInfo.attendees || 'æœªå®š'}`;

        const previousTitlesText = proposalHistory.length > 0 
          ? `\nå‰å›ã®ææ¡ˆ: ${proposalHistory.slice(-6).join(', ')}\nä¸Šè¨˜ã¨ã¯ç•°ãªã‚‹æ–°ã—ã„ææ¡ˆã‚’ã—ã¦ãã ã•ã„ã€‚`
          : '';

        const userPrompt = `${partyInfoText}

ã€ææ¡ˆã‚¸ãƒ£ãƒ³ãƒ«ï¼ˆä»Šå›ã¯ã“ã®3ã¤ã‹ã‚‰ï¼‰ã€‘
ææ¡ˆ1: ${selectedCategories[0]}
ææ¡ˆ2: ${selectedCategories[1]}
ææ¡ˆ3: ${selectedCategories[2]}

ã€ãƒ«ãƒ¼ãƒ«ã€‘

1. ã‚¿ã‚¤ãƒˆãƒ«ã¯ã€Œé›°å›²æ°—ãƒ»ãƒ†ãƒ¼ãƒã€ã‚’è¡¨ç¾
   â—‹ ã€Œ1950å¹´ä»£ãƒ•ã‚£ãƒ«ãƒ ãƒãƒ¯ãƒ¼ãƒ«æ¢åµé¢¨ã€ã€Œãƒ›ãƒ¯ã‚¤ãƒˆã‚¿ã‚¤ï¼ˆæ­£ç¤¼è£…ï¼‰ã€ã€Œ18ä¸–ç´€ãƒ•ãƒ©ãƒ³ã‚¹é©å‘½æœŸå¸‚æ°‘ã€
   â—‹ ã€Œâ—‹â—‹é¢¨ã€ã ã‘ã§ãªãã€æ­£çµ±æ´¾ãƒ‰ãƒ¬ã‚¹ã‚³ãƒ¼ãƒ‰ï¼ˆãƒ›ãƒ¯ã‚¤ãƒˆã‚¿ã‚¤ã€ãƒ–ãƒ©ãƒƒã‚¯ã‚¿ã‚¤ç­‰ï¼‰ã‚‚ç©æ¥µçš„ã«
   Ã— ã€Œé»’ã„ã‚µãƒ³ã‚°ãƒ©ã‚¹1ã¤ã ã‘ã€ï¼ˆå…·ä½“çš„ã‚¢ã‚¤ãƒ†ãƒ æŒ‡å®šã¯NGï¼‰

2. èª¬æ˜æ–‡ã®æ§‹æˆ
   - ã„ããªã‚Šæœ¬é¡Œã‹ã‚‰ï¼ˆå—ã‘æ­¢ã‚æ–‡ã€Œã‹ã—ã“ã¾ã‚Šã¾ã—ãŸã€ç­‰ã¯ä¸è¦ï¼‰
   - 2-3æ–‡ã€150æ–‡å­—ç¨‹åº¦
   - å…·ä½“ä¾‹ãƒ»å…¥æ‰‹å…ˆã®ãƒ’ãƒ³ãƒˆã‚’å«ã‚ã‚‹

3. ææ¡ˆã®ãƒãƒ©ãƒ³ã‚¹
   - æ„å¤–æ€§ã®ã‚ã‚‹ã‚‚ã®1-2å€‹
   - å®Ÿç¾ã—ã‚„ã™ã„ã‚‚ã®1-2å€‹
   - ã€Œâ—‹â—‹é¢¨ã€ä»¥å¤–ã®è¡¨ç¾ã‚‚ç©æ¥µçš„ã«ï¼ˆæ­£çµ±æ´¾ãƒ‰ãƒ¬ã‚¹ã‚³ãƒ¼ãƒ‰ã€å’Œè£…ã€ãƒˆãƒ¬ãƒ³ãƒ‰ç³»ç­‰ï¼‰

4. å®Ÿç¾å¯èƒ½æ€§ã®å·¥å¤«
   - å®Œç’§å†ç¾ã§ã¯ãªãã€Œé›°å›²æ°—ã‚’å‡ºã™ã€
   - 100å††ã‚·ãƒ§ãƒƒãƒ—ã€å¤ç€ã€æ™®æ®µç€ã®æ´»ç”¨
   - å°ç‰©ã ã‘ã§ã‚‚æˆç«‹ã•ã›ã‚‹
${previousTitlesText}

ã€å‡ºåŠ›å½¢å¼JSONã€‘
{
  "proposal1": {
    "title": "ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ20æ–‡å­—ä»¥å†…ï¼‰",
    "description": "èª¬æ˜æ–‡ï¼ˆ150æ–‡å­—ç¨‹åº¦ã€å—ã‘æ­¢ã‚æ–‡ãªã—ï¼‰",
    "keywords": ["è‹±èª", "ç”»åƒæ¤œç´¢ç”¨", "å…·ä½“çš„"]
  },
  "proposal2": { ... },
  "proposal3": { ... }
}

â€» keywords: ç”»åƒæ¤œç´¢ç”¨ã®è‹±èªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆè¦–è¦šçš„ã«ç‰¹å¾´çš„ãªã‚‚ã®ã‚’é¸ã¶ï¼‰
ä¾‹: ["spy", "detective", "noir"], ["18th century france", "revolutionary"]`;

        try {
          const response = await fetch('/api/claude', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 1500,
              temperature: 0.9,
              system: systemPrompt,
              messages: [
                { role: 'user', content: userPrompt }
              ]
            })
          });

          const data = await response.json();
          
          if (!response.ok) {
            console.error('API Error:', data);
            throw new Error('API call failed');
          }
          
          const content = data.content.find(item => item.type === 'text')?.text || '';
          
          // JSONã‚’æŠ½å‡º
          const jsonMatch = content.match(/\{[\s\S]*\}/);
          if (jsonMatch) {
            const proposalsData = JSON.parse(jsonMatch[0]);
            const proposalsArray = [
              proposalsData.proposal1,
              proposalsData.proposal2,
              proposalsData.proposal3
            ];
            
            // Pexels APIã§ç”»åƒã‚’å–å¾—
            const PEXELS_API_KEY = '6nzrz3VavQN3KgZpxfFsKyYtYNTSEkbaAumMBHUAaGRaeyKFDd2fGLpy';
            
            const proposalsWithImages = await Promise.all(
              proposalsArray.map(async (proposal, index) => {
                try {
                  const query = proposal.keywords.join(' ');
                  const imageResponse = await fetch(
                    `https://api.pexels.com/v1/search?query=${encodeURIComponent(query)}&per_page=1`,
                    {
                      headers: {
                        Authorization: PEXELS_API_KEY
                      }
                    }
                  );
                  const imageData = await imageResponse.json();
                  const imageUrl = imageData.photos && imageData.photos[0] 
                    ? imageData.photos[0].src.large 
                    : 'https://images.pexels.com/photos/1040945/pexels-photo-1040945.jpeg'; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”»åƒ
                  
                  return {
                    ...proposal,
                    imageUrl,
                    category: selectedCategoriesWithKeys[index].key
                  };
                } catch (error) {
                  console.error('Image fetch error:', error);
                  return {
                    ...proposal,
                    imageUrl: 'https://images.pexels.com/photos/1040945/pexels-photo-1040945.jpeg',
                    category: selectedCategoriesWithKeys[index].key
                  };
                }
              })
            );
            
            setProposals(proposalsWithImages);
            setProposalHistory(prev => [...prev, ...proposalsWithImages.map(p => p.title)]);
            setStep('selection');
          }
        } catch (error) {
          console.error('Error:', error);
          // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿
          const dummyProposals = [
            {
              title: "18ä¸–ç´€ãƒ•ãƒ©ãƒ³ã‚¹é©å‘½æœŸã‚¹ã‚¿ã‚¤ãƒ«",
              description: "ã‚µãƒ³ã‚­ãƒ¥ãƒ­ãƒƒãƒˆã®æ°‘è¡†é¢¨ã§ã”ã–ã„ã¾ã™ã€‚èµ¤ã„å¸½å­ã«é•·ã‚ºãƒœãƒ³ã€ä¸‰è‰²æ——ã®ã‚¹ã‚«ãƒ¼ãƒ•ã§ã€‚å¤ç€å±‹ã‚„é€šè²©ã§æƒã„ã¾ã™ã—ã€å°ç‰©ã ã‘ã§ã‚‚é›°å›²æ°—ãŒå‡ºã¾ã™ã€‚",
              keywords: ["french", "revolution", "1700s"],
              imageUrl: "https://images.pexels.com/photos/1040945/pexels-photo-1040945.jpeg"
            },
            {
              title: "ã‚¹ãƒ‘ã‚¤é¢¨",
              description: "007ã®ã‚ˆã†ãªæ´—ç·´ã•ã‚ŒãŸã‚¹ãƒ‘ã‚¤é¢¨ã¯ã„ã‹ãŒã§ã—ã‚‡ã†ã€‚é»’ã®ã‚µãƒ³ã‚°ãƒ©ã‚¹ã‚„è¬ã®å°ç­’ãªã©ã€å°ç‰©1ã¤ã ã‘ã§OKã§ã”ã–ã„ã¾ã™ã€‚æ™®æ®µç€ã«ãƒ—ãƒ©ã‚¹ã™ã‚‹ã ã‘ã§é›°å›²æ°—ãŒå‡ºã¾ã™ã€‚",
              keywords: ["spy", "sunglasses", "agent"],
              imageUrl: "https://images.pexels.com/photos/1040945/pexels-photo-1040945.jpeg"
            },
            {
              title: "3æ—¥å¾¹å¤œæ˜ã‘ã®äºº",
              description: "ç–²åŠ´å›°æ†Šã—ãŸçŠ¶æ…‹ã‚’è¡¨ç¾ã„ãŸã—ã¾ã™ã€‚ç›®ã®ä¸‹ã«ã‚¯ãƒã€ã‚³ãƒ¼ãƒ’ãƒ¼ã‚«ãƒƒãƒ—æŒå‚ã€é«ªãƒœã‚µãƒœã‚µã§ã€‚æ¼”æŠ€åŠ›ãŒè©¦ã•ã‚Œã¾ã™ã€‚",
              keywords: ["tired", "sleepy", "coffee"],
              imageUrl: "https://images.pexels.com/photos/1040945/pexels-photo-1040945.jpeg"
            }
          ];
          
          setProposals(dummyProposals);
          setProposalHistory(prev => [...prev, ...dummyProposals.map(p => p.title)]);
          setStep('selection');
        } finally {
          setLoading(false);
        }
      };

      const selectProposal = (proposal) => {
        setSelectedProposal(proposal);
        generateOutfit(proposal);
      };

      const handleNone = async () => {
        setLoading(true);
        
        // åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã§æ–°ã—ã„ææ¡ˆã‚’ç”Ÿæˆ
        await generateProposals();
      };

      const generateOutfit = async (proposal) => {
        setLoading(true);
        
        const systemPrompt = `ã‚ãªãŸã¯é«˜ç´šãƒ†ãƒ¼ãƒ©ãƒ¼ï¼ˆä»•ç«‹å±‹ï¼‰ã®åº—ä¸»ã§ã™ã€‚
ãŠå®¢æ§˜ãŒé¸ã‚“ã ãƒ‰ãƒ¬ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã€å®Ÿéš›ã«å®Ÿç¾ã§ãã‚‹ã‚ˆã†å…·ä½“çš„ã«ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚

ã€çµ¶å¯¾å³å®ˆã€‘
- ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨˜å·ï¼ˆ**å¤ªå­—**ã€_ã‚¤ã‚¿ãƒªãƒƒã‚¯_ãªã©ï¼‰ã¯ä¸€åˆ‡ä½¿ç”¨ç¦æ­¢
- æ–‡å­—åŒ–ã‘ã™ã‚‹ç‰¹æ®Šæ–‡å­—ã¯ä½¿ç”¨ç¦æ­¢
- å†’é ­æ–‡ã¯é•·ãè©³ç´°ã«ï¼ˆ5-7æ–‡ã€200-300æ–‡å­—ç¨‹åº¦ï¼‰
- ææ¡ˆã¯ç°¡æ½”ã«ï¼ˆå„ã‚»ã‚¯ã‚·ãƒ§ãƒ³2-3è¡Œç¨‹åº¦ï¼‰
- å®Ÿç”¨æ€§é‡è¦–ï¼ˆæœ¬æ°—ã§å®Ÿç¾ã•ã›ã‚‹å‰æï¼‰
- ä¸å¯§ã§çœŸé¢ç›®ãªå£èª¿`;

        const userPrompt = `é¸æŠã•ã‚ŒãŸãƒ‰ãƒ¬ã‚¹ã‚³ãƒ¼ãƒ‰: ã€Œ${proposal.title}ã€
èª¬æ˜: ${proposal.description}

ãŠå®¢æ§˜ã®æƒ…å ±:
- æ€§åˆ¥: ${partyInfo.userGender}
- å¹´ä»£: ${partyInfo.ageGroup}
- äºˆç®—: ${partyInfo.budget}

ã“ã®ãƒ‰ãƒ¬ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®ã€ç°¡æ½”ãªã‚³ãƒ¼ãƒ‡ã‚£ãƒãƒ¼ãƒˆææ¡ˆã‚’ã—ã¦ãã ã•ã„ã€‚

ã€ææ¡ˆå†…å®¹ã€‘

## å†’é ­ã®æŒ¨æ‹¶ãƒ»åˆ†æ
ã€Œæ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚[ãƒ‰ãƒ¬ã‚¹ã‚³ãƒ¼ãƒ‰å]ã§ã”ã–ã„ã¾ã™ã­ã€‚ã€ã‹ã‚‰å§‹ã‚ã€ä»¥ä¸‹ã‚’å«ã‚ã‚‹5-7æ–‡:
1. ã“ã®ãƒ‰ãƒ¬ã‚¹ã‚³ãƒ¼ãƒ‰ã®ã€Œè‚ã€ã¯ä½•ã‹ï¼ˆæœ¬è³ªçš„ãªè¦ç´ ï¼‰
2. å®Œç’§å†ç¾ãŒé›£ã—ã„å ´åˆã€ã©ã†å·¥å¤«ã—ã¦è»½ãæº€ãŸã™ã‹
3. æ„å¤–ãªåˆ‡ã‚Šå£ãƒ»é€†å¼µã‚Šã®ææ¡ˆï¼ˆä¾‹: å®ãã˜å½“é¸è€…ãªã‚‰é€†ã«éš ã™ã€ãªã©ï¼‰
4. ã‚¢ã‚¤ãƒ†ãƒ ç´¹ä»‹ã¸ã®ã¤ãªã

ä¾‹:
ã€Œæ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚ãƒãƒªå¸å›½è²´æ—é¢¨ã§ã”ã–ã„ã¾ã™ã­ã€‚ã“ã®ãƒ‰ãƒ¬ã‚¹ã‚³ãƒ¼ãƒ‰ã®è‚ã¯ã€é‡‘ã®è£…é£¾ã¨é®®ã‚„ã‹ãªå¸ƒåœ°ã«ã‚ˆã‚‹ã€å¯Œã®èª‡ç¤ºã€ã«ã”ã–ã„ã¾ã™ã€‚ã—ã‹ã—ãªãŒã‚‰ã€ç¾ä»£ã®æ—¥æœ¬ã§å®Œç’§ã«å†ç¾ã™ã‚‹ã®ã¯é›£ã—ã‚…ã†ã”ã–ã„ã¾ã™ã®ã§ã€æœ¬æ—¥ã¯ã€é‡‘è‰²ã®å°ç‰©1ç‚¹ã€ã¨ã€å¹¾ä½•å­¦æ¨¡æ§˜ã®ã‚¹ãƒˆãƒ¼ãƒ«ã€ã ã‘ã§é›°å›²æ°—ã‚’å‡ºã™å®Ÿç”¨çš„ãªæ–¹æ³•ã‚’ã”ææ¡ˆã„ãŸã—ã¾ã™ã€‚æ„å¤–ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€å®ãã˜å½“é¸è€…ã®æ–¹ã§ã‚ã‚Œã°ã€ã‚ãˆã¦ã€æ§ãˆã‚ãªæˆé‡‘æ„Ÿã€ã‚’æ¼”å‡ºã™ã‚‹ã“ã¨ã§ã€ã‹ãˆã£ã¦æœ¬ç‰©ã‚‰ã—ã•ãŒå‡ºã‚‹ã¨å­˜ã˜ã¾ã™ã€‚ã§ã¯ã€å…·ä½“çš„ãªã‚¢ã‚¤ãƒ†ãƒ ã‚’ã”è¦§ãã ã•ã„ã€‚ã€

## ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆ
3-4å€‹ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç®‡æ¡æ›¸ãï¼ˆãƒ»ï¼‰ã§åˆ—æŒ™ã€‚
å„ã‚¢ã‚¤ãƒ†ãƒ ã«ã¯ã€Œå…·ä½“çš„ãªç‰¹å¾´ï¼ˆè‰²ãƒ»ç´ æãƒ»ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ»å°‚é–€ç”¨èªï¼‰ã€ã‚’è¨˜è¼‰ã€‚
ä¾‹: ãƒ»ãƒˆãƒƒãƒ—ã‚¹: ã‚¤ãƒ³ãƒ‡ã‚£ã‚´ãƒ–ãƒ«ãƒ¼ã®ã‚¿ã‚®ãƒ«ãƒ ã‚¹ãƒˆï¼ˆãƒˆã‚¥ã‚¢ãƒ¬ã‚°æ—ä¼çµ±ã‚¿ãƒ¼ãƒãƒ³ã€æ¥½å¤©ã§2,500å††ç¨‹åº¦ï¼‰

é‡è¦: æ¤œç´¢ã—ã‚„ã™ã„å°‚é–€ç”¨èªã‚’ä½¿ç”¨
- Ã— ã€Œã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ã€â†’ â—‹ ã€Œãƒˆã‚¥ã‚¢ãƒ¬ã‚°æ—ãƒãƒ§ãƒ¼ã‚«ãƒ¼ã€
- Ã— ã€Œãƒˆãƒƒãƒ—ã‚¹ã€â†’ â—‹ ã€Œ18ä¸–ç´€ãƒ–ãƒªã‚ªãƒ¼å¸½å­ã€
- Ã— ã€Œå¸ƒã€â†’ â—‹ ã€Œã‚«ãƒ³ã‚¬ãƒ»ãƒ‘ãƒ¼ãƒ‹ãƒ¥ ã‚¢ãƒ•ãƒªã‚«å¸ƒã€

## äºˆç®—é…åˆ†
${partyInfo.budget}å†…ã§æƒãˆã‚‹æ–¹æ³•ã‚’2-3è¡Œã§ã€‚

## å…¥æ‰‹æ–¹æ³•
è³¼å…¥å…ˆã‚’1-2è¡Œã§ç°¡æ½”ã«ã€‚å°‚é–€åº—åã‚„å…·ä½“çš„ãªãƒ–ãƒ©ãƒ³ãƒ‰åã‚’å«ã‚ã‚‹ã€‚

## ç€ã“ãªã—ã®ãƒã‚¤ãƒ³ãƒˆ
é›°å›²æ°—ã‚’å‡ºã™ã‚³ãƒ„ã‚’2-3è¡Œã§ã€‚

ã€çµ¶å¯¾ç¦æ­¢ã€‘
- **å¤ªå­—**ã€_ã‚¤ã‚¿ãƒªãƒƒã‚¯_ãªã©ã®ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨˜å·
- ç‰¹æ®Šæ–‡å­—ï¼ˆï¿½ï¿½ãªã©æ–‡å­—åŒ–ã‘ã™ã‚‹ã‚‚ã®ï¼‰
- é•·æ–‡èª¬æ˜ï¼ˆå†’é ­ä»¥å¤–ã¯å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³3è¡Œä»¥å†…ï¼‰
- ä¸€èˆ¬çš„ã™ãã‚‹å˜èªï¼ˆã€Œãƒˆãƒƒãƒ—ã‚¹ã€ã€Œã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ã€ã ã‘ã¯NGï¼‰`;

        try {
          const response = await fetch('/api/claude', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 1000,
              temperature: 0.7,
              system: systemPrompt,
              messages: [
                { role: 'user', content: userPrompt }
              ]
            })
          });

          const data = await response.json();
          
          if (!response.ok) {
            console.error('API Error:', data);
            throw new Error('API call failed');
          }
          
          const content = data.content.find(item => item.type === 'text')?.text || '';
          
          // ã‚¢ã‚¤ãƒ†ãƒ åã‚’æŠ½å‡ºï¼ˆæ”¹å–„ç‰ˆ: å…·ä½“çš„ãªèª¬æ˜ã‚’å«ã‚ã‚‹ï¼‰
          const items = [];
          
          // "ãƒ»ã‚¢ã‚¤ãƒ†ãƒ å: èª¬æ˜" ã®å½¢å¼ã‹ã‚‰æŠ½å‡º
          const itemPattern = /ãƒ»([^ï¼š:\n]+)[ï¼š:]([^\nï¼ˆ(]+)/g;
          let match;
          while ((match = itemPattern.exec(content)) !== null) {
            const itemCategory = match[1].trim(); // ãƒˆãƒƒãƒ—ã‚¹ã€ãƒœãƒˆãƒ ã‚¹ç­‰
            const itemDetail = match[2].trim();    // å…·ä½“çš„ãªèª¬æ˜
            
            // å…·ä½“çš„ãªèª¬æ˜ã‹ã‚‰æœ€åˆã®æ•°å˜èªã‚’æŠ½å‡ºï¼ˆä¾¡æ ¼ãƒ»åº—èˆ—æƒ…å ±ã‚’é™¤å¤–ï¼‰
            const detailWords = itemDetail
              .replace(/ï¼ˆ.*?ï¼‰/g, '') // æ‹¬å¼§å†…ã‚’å‰Šé™¤
              .replace(/\(.*?\)/g, '')
              .replace(/[0-9,]+å††.*/, '') // ä¾¡æ ¼æƒ…å ±ã‚’å‰Šé™¤
              .replace(/ã€.*/, '') // è¤‡æ•°ã®èª¬æ˜ãŒã‚ã‚‹å ´åˆã¯æœ€åˆã ã‘
              .split(/\s+/)
              .slice(0, 3) // æœ€åˆã®3å˜èªã¾ã§
              .join(' ')
              .trim();
            
            if (detailWords && detailWords.length > 2) {
              items.push(detailWords);
            } else if (itemCategory) {
              // å…·ä½“çš„ãªèª¬æ˜ãŒãªã„å ´åˆã¯ã‚«ãƒ†ã‚´ãƒªåã‚’ä½¿ç”¨
              items.push(itemCategory);
            }
          }
          
          // ã‚¢ã‚¤ãƒ†ãƒ ãŒæŠ½å‡ºã§ããªã‹ã£ãŸå ´åˆã¯ã€ãƒ‰ãƒ¬ã‚¹ã‚³ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ç”Ÿæˆ
          if (items.length === 0) {
            const dresscode = selectedProposal.title;
            items.push(`${dresscode} è¡£è£…`);
          }
          
          setOutfit({
            content: content,
            items: items.slice(0, 6) // æœ€å¤§6å€‹ã¾ã§
          });
          setStep('outfit');
        } catch (error) {
          console.error('Error:', error);
          // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿
          const dummyOutfit = {
            content: `${personalInfo.gender === 'Male' ? 'ç”·æ€§' : personalInfo.gender === 'Female' ? 'å¥³æ€§' : ''}å‘ã‘ã®${selectedProposal.title}ã®å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‡ã‚£ãƒãƒ¼ãƒˆææ¡ˆã§ã”ã–ã„ã¾ã™ã€‚\n\nã€ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆã€‘\nãƒ»ãƒˆãƒƒãƒ—ã‚¹: â—‹â—‹â—‹ï¼ˆè‰²ã€ãƒ‡ã‚¶ã‚¤ãƒ³è©³ç´°ï¼‰\nãƒ»ãƒœãƒˆãƒ ã‚¹: â—‹â—‹â—‹\nãƒ»é´: â—‹â—‹â—‹\nãƒ»å°ç‰©: â—‹â—‹â—‹\n\nã€äºˆç®—é…åˆ†ã€‘\n${personalInfo.budget}å†…ã§æƒãˆã‚‹æ–¹æ³•ã‚’ã”ææ¡ˆã„ãŸã—ã¾ã™ã€‚\nãƒ»å¿…é ˆã‚¢ã‚¤ãƒ†ãƒ : â—‹â—‹â—‹ï¼ˆäºˆç®—ã®50%ï¼‰\nãƒ»ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ: â—‹â—‹â—‹ï¼ˆäºˆç®—ã®30%ï¼‰\nãƒ»å°ç‰©: â—‹â—‹â—‹ï¼ˆäºˆç®—ã®20%ï¼‰\n\nã€å…¥æ‰‹æ–¹æ³•ã€‘\nãƒ»æ¥½å¤©å¸‚å ´ã€Amazonã§ã€Œâ—‹â—‹â—‹ã€ã¨æ¤œç´¢\nãƒ»ã—ã¾ã‚€ã‚‰ã€ãƒ‰ãƒ³ãƒ»ã‚­ãƒ›ãƒ¼ãƒ†ãªã©ã§æ‰‹é ƒã«\nãƒ»100å††ã‚·ãƒ§ãƒƒãƒ—ã§å°ç‰©ã‚’\nãƒ»ãƒ¬ãƒ³ã‚¿ãƒ«è¡£è£…åº—ã‚‚æ´»ç”¨å¯èƒ½ã§ã”ã–ã„ã¾ã™\n\nã€ç€ã“ãªã—ã®ãƒã‚¤ãƒ³ãƒˆã€‘\nã“ã®é›°å›²æ°—ã‚’å‡ºã™ã«ã¯...`,
            items: [selectedProposal.title.includes('ã‚¹ãƒ‘ã‚¤') ? 'é»’ã‚µãƒ³ã‚°ãƒ©ã‚¹' : 'ãƒˆãƒƒãƒ—ã‚¹', 'ãƒœãƒˆãƒ ã‚¹', 'é´', 'å°ç‰©']
          };
          
          setOutfit(dummyOutfit);
          setStep('outfit');
        } finally {
          setLoading(false);
        }
      };

      // ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼æƒ…å ±å…¥åŠ›ç”»é¢
      if (step === 'input') {
        return (
          <div className="min-h-screen bg-black text-white flex items-center justify-center p-6">
            {/* ãƒ­ã‚´ - å·¦ä¸Šå›ºå®š */}
            <div className="fixed top-6 left-6 z-50">
              <button onClick={() => setStep('input')} className="text-2xl font-extralight tracking-[0.3em] text-gray-200 hover:text-white transition-colors">
                DRESS CODEs
              </button>
            </div>
            
            {/* é¸ã°ã‚ŒãŸææ¡ˆã‚«ãƒ«ãƒ¼ã‚»ãƒ« - å³å´å›ºå®š */}
            {okList.length > 0 && (
              <div className="fixed right-6 top-1/2 -translate-y-1/2 z-50 w-48">
                <button
                  onClick={() => setStep('okList')}
                  className="w-full mb-4 px-4 py-2 bg-gray-900 border border-gray-700 text-gray-200 hover:text-white hover:border-gray-500 transition-colors text-sm"
                >
                  é¸ã°ã‚ŒãŸææ¡ˆ ({okList.length})
                </button>
                <div className="space-y-3 max-h-96 overflow-y-auto">
                  {okList.slice(-3).reverse().map(entry => (
                    <button
                      key={entry.id}
                      onClick={() => setStep('okList')}
                      className="w-full bg-gray-950 border border-gray-800 p-3 hover:border-gray-600 transition-all text-left"
                    >
                      <img
                        src={entry.imageUrl}
                        alt={entry.dressCode}
                        className="w-full h-24 object-cover mb-2"
                      />
                      <p className="text-xs text-gray-300 truncate">{entry.dressCode}</p>
                      <div className="text-yellow-500 text-xs mt-1">
                        {'â˜…'.repeat(entry.rating)}
                      </div>
                    </button>
                  ))}
                </div>
              </div>
            )}
            
            <div className="max-w-4xl w-full">
              <img 
                src="butler.png" 
                alt="Butler" 
                style={{height: '375px', width: 'auto'}} 
                className="mx-auto mb-12 animate-fade-in" 
              />
              
              <p className="text-center text-gray-100 mb-16 serif text-2xl">
                ã©ã®ã‚ˆã†ãªãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ã®ã”äºˆå®šã§ã—ã‚‡ã†ã‹
              </p>

              <div className="space-y-12">
                <div className="border-t border-gray-900 pt-8 animate-line-grow animate-fade-in">
                  <label className="block text-xs uppercase tracking-[0.2em] text-gray-200 mb-4 serif">
                    01 / å¹´ä»£
                  </label>
                  <div className="flex gap-4 md:gap-6 flex-wrap justify-center">
                    {['20ä»£', '30ä»£', '40ä»£', '50ä»£ä»¥ä¸Š'].map(age => (
                      <label key={age} className="flex items-center gap-2 cursor-pointer group px-3 py-2 -mx-3 -my-2">
                        <input
                          type="radio"
                          name="ageGroup"
                          checked={partyInfo.ageGroup === age}
                          onChange={() => handleInputChange('ageGroup', age)}
                          className="w-5 h-5 md:w-4 md:h-4 accent-white cursor-pointer"
                        />
                        <span className={`text-base md:text-sm serif transition-colors ${
                          partyInfo.ageGroup === age ? 'text-white' : 'text-gray-200 group-hover:text-gray-200'
                        }`}>
                          {age}
                        </span>
                      </label>
                    ))}
                  </div>
                </div>

                <div className="border-t border-gray-900 pt-8 animate-line-grow animate-fade-in" style={{animationDelay: '0.1s'}}>
                  <label className="block text-xs uppercase tracking-[0.2em] text-gray-200 mb-4 serif">
                    02 / æ€§åˆ¥
                  </label>
                  <div className="flex gap-6 flex-wrap justify-center">
                    {['ç”·æ€§', 'å¥³æ€§', 'ãã®ä»–'].map(gender => (
                      <label key={gender} className="flex items-center gap-2 cursor-pointer group px-3 py-2 -mx-3 -my-2">
                        <input
                          type="radio"
                          name="userGender"
                          checked={partyInfo.userGender === gender}
                          onChange={() => handleInputChange('userGender', gender)}
                          className="w-5 h-5 md:w-4 md:h-4 accent-white cursor-pointer"
                        />
                        <span className={`text-sm serif transition-colors ${
                          partyInfo.userGender === gender ? 'text-white' : 'text-gray-200 group-hover:text-gray-200'
                        }`}>
                          {gender}
                        </span>
                      </label>
                    ))}
                  </div>
                </div>

                <div className="border-t border-gray-900 pt-8 animate-line-grow animate-fade-in" style={{animationDelay: '0.2s'}}>
                  <label className="block text-xs uppercase tracking-[0.2em] text-gray-200 mb-4 serif">
                    03 / å ´æ‰€
                  </label>
                  <div className="flex gap-6 flex-wrap justify-center">
                    {['ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³', 'å±…é…’å±‹', 'ã‚«ãƒ•ã‚§', 'é‡å¤–', 'å®¶', 'ãã®ä»–'].map(loc => (
                      <label key={loc} className="flex items-center gap-2 cursor-pointer group px-3 py-2 -mx-3 -my-2">
                        <input
                          type="radio"
                          name="location"
                          checked={partyInfo.location === loc}
                          onChange={() => handleInputChange('location', loc)}
                          className="w-5 h-5 md:w-4 md:h-4 accent-white cursor-pointer"
                        />
                        <span className={`text-sm serif transition-colors ${
                          partyInfo.location === loc ? 'text-white' : 'text-gray-200 group-hover:text-gray-200'
                        }`}>
                          {loc}
                        </span>
                      </label>
                    ))}
                  </div>
                </div>

                <div className="border-t border-gray-900 pt-8 animate-line-grow animate-fade-in" style={{animationDelay: '0.3s'}}>
                  <label className="block text-xs uppercase tracking-[0.2em] text-gray-200 mb-4 serif">
                    04 / é›°å›²æ°—
                  </label>
                  <input
                    type="text"
                    value={partyInfo.atmosphere}
                    onChange={(e) => handleInputChange('atmosphere', e.target.value)}
                    placeholder="ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã€æ¥½ã—ã„ã€ã‚¨ãƒ¬ã‚¬ãƒ³ãƒˆ..."
                    className="w-full bg-gray-900 text-gray-200 text-sm tracking-wide border border-gray-700 p-4 focus:border-white focus:outline-none transition-all placeholder-gray-500 serif shadow-sm"
                  />
                </div>

                <div className="border-t border-gray-900 pt-8 animate-line-grow animate-fade-in" style={{animationDelay: '0.4s'}}>
                  <label className="block text-xs uppercase tracking-[0.2em] text-gray-200 mb-4 serif">
                    05 / å‚åŠ äººæ•°
                  </label>
                  <input
                    type="text"
                    value={partyInfo.attendees}
                    onChange={(e) => handleInputChange('attendees', e.target.value)}
                    placeholder="10äººãã‚‰ã„..."
                    className="w-full bg-gray-900 text-gray-200 text-sm tracking-wide border border-gray-700 p-4 focus:border-white focus:outline-none transition-all placeholder-gray-500 serif shadow-sm"
                  />
                </div>

                <div className="border-t border-gray-900 pt-8 animate-line-grow animate-fade-in" style={{animationDelay: '0.5s'}}>
                  <label className="block text-xs uppercase tracking-[0.2em] text-gray-200 mb-4 serif">
                    06 / è¡£è£…äºˆç®—
                  </label>
                  <div className="flex gap-6 flex-wrap justify-center">
                    {['ï½3000å††', 'ï½10000å††', 'åˆ¶é™ãªã—'].map(budget => (
                      <label key={budget} className="flex items-center gap-2 cursor-pointer group px-3 py-2 -mx-3 -my-2">
                        <input
                          type="radio"
                          name="budget"
                          checked={partyInfo.budget === budget}
                          onChange={() => handleInputChange('budget', budget)}
                          className="w-5 h-5 md:w-4 md:h-4 accent-white cursor-pointer"
                        />
                        <span className={`text-sm serif transition-colors ${
                          partyInfo.budget === budget ? 'text-white' : 'text-gray-200 group-hover:text-gray-200'
                        }`}>
                          {budget}
                        </span>
                      </label>
                    ))}
                  </div>
                </div>

                <div className="border-t border-gray-800 pt-16 pb-8 animate-line-grow animate-fade-in" style={{animationDelay: '0.6s'}}>
                  <button
                    onClick={generateProposals}
                    disabled={loading}
                    className="group text-2xl uppercase tracking-[0.3em] text-gray-100 hover:text-white transition-colors disabled:opacity-50 cursor-pointer border-b-2 border-transparent hover:border-white pb-2"
                  >
                    <span className="text-gray-200 group-hover:text-gray-200 transition-colors">/</span> {loading ? (
                      <span className="inline-flex items-center gap-2 text-white font-semibold">
                        åŸ·äº‹ãŒè€ƒãˆä¸­
                        <span className="inline-flex gap-1">
                          <span className="animate-bounce" style={{animationDelay: '0s'}}>.</span>
                          <span className="animate-bounce" style={{animationDelay: '0.2s'}}>.</span>
                          <span className="animate-bounce" style={{animationDelay: '0.4s'}}>.</span>
                        </span>
                      </span>
                    ) : 'ã”ææ¡ˆ â†’'}
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // ãƒ‰ãƒ¬ã‚¹ã‚³ãƒ¼ãƒ‰é¸æŠç”»é¢
      if (step === 'selection' && proposals) {
        return (
          <div className="min-h-screen bg-black text-white p-6 py-12">
            {/* ãƒ­ã‚´ - å·¦ä¸Šå›ºå®š */}
            <div className="fixed top-6 left-6 z-50">
              <button onClick={() => setStep('input')} className="text-xl font-extralight tracking-[0.3em] text-gray-200 hover:text-white transition-colors">
                DRESS CODEs
              </button>
            </div>
            
            {/* é¸ã°ã‚ŒãŸææ¡ˆ - å³ä¸‹å›ºå®š */}
            {okList.length > 0 && (
              <button
                onClick={() => setStep('okList')}
                className="fixed bottom-6 right-6 z-50 px-4 py-2 bg-gray-900 border border-gray-700 text-gray-300 hover:text-white hover:border-gray-500 transition-colors text-sm"
              >
                é¸ã°ã‚ŒãŸææ¡ˆ ({okList.length})
              </button>
            )}
            
            <img 
              src="butler.png" 
              alt="Butler" 
              style={{height: '180px', width: 'auto'}} 
              className="mx-auto mb-6" 
            />
            
            <p className="text-center text-gray-200 mb-8 serif text-lg max-w-4xl mx-auto">
              ã‹ã—ã“ã¾ã‚Šã¾ã—ãŸã€‚ã“ã†ã„ã£ãŸãƒ‰ãƒ¬ã‚¹ã‚³ãƒ¼ãƒ‰ã§ã¯ã„ã‹ãŒã§ã—ã‚‡ã†ã‹
            </p>
            
            {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
            <div className="max-w-7xl mx-auto mb-8 flex justify-end items-center">
              <button
                onClick={reset}
                className="text-sm text-gray-200 hover:text-white transition-colors uppercase tracking-wider"
              >
                ã‚„ã‚ã‚‹
              </button>
            </div>

            {/* ã‚«ãƒ¼ãƒ‰è¡¨ç¤º */}
            <div className="max-w-7xl mx-auto">
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 mb-8 px-2 md:px-0">
                {proposals.map((proposal, index) => (
                  <div
                    key={index}
                    onClick={() => selectProposal(proposal)}
                    className="card bg-gray-950 border-2 border-gray-900 overflow-hidden hover:border-white transition-all cursor-pointer active:scale-95"
                  >
                    <img
                      src={proposal.imageUrl}
                      alt={proposal.title}
                      className="card-image w-full h-48 md:h-64 object-cover"
                    />
                    <div className="p-4 md:p-6">
                      <h3 className="text-base md:text-lg font-light mb-2 md:mb-3 tracking-wide">{proposal.title}</h3>
                      <p className="text-xs md:text-sm text-gray-200 serif leading-relaxed">{proposal.description}</p>
                    </div>
                  </div>
                ))}
              </div>

              {/* NONEã‚«ãƒ¼ãƒ‰ */}
              <div className="flex justify-center">
                <button
                  onClick={handleNone}
                  disabled={loading}
                  className="card bg-gray-950 border border-gray-800 p-8 min-w-[300px] hover:border-gray-600 disabled:opacity-50"
                >
                  <h3 className="text-xl font-light mb-2 tracking-wide">NONE</h3>
                  <p className="text-sm text-gray-200 serif">
                    {loading ? (
                      <span className="inline-flex items-center gap-2 text-white font-semibold">
                        åŸ·äº‹ãŒææ¡ˆã‚’è€ƒãˆä¸­
                        <span className="inline-flex gap-1">
                          <span className="animate-bounce" style={{animationDelay: '0s'}}>.</span>
                          <span className="animate-bounce" style={{animationDelay: '0.2s'}}>.</span>
                          <span className="animate-bounce" style={{animationDelay: '0.4s'}}>.</span>
                        </span>
                      </span>
                    ) : 'ä»–ã®ææ¡ˆã‚’è¦‹ã‚‹'}
                  </p>
                </button>
              </div>
            </div>
          </div>
        );
      }


      // ã‚³ãƒ¼ãƒ‡ã‚£ãƒãƒ¼ãƒˆææ¡ˆç”»é¢
      if (step === 'outfit' && outfit) {
        return (
          <div className="min-h-screen bg-black text-white p-6 py-12">
            {/* ãƒ­ã‚´ - å·¦ä¸Šå›ºå®š */}
            <div className="fixed top-6 left-6 z-50">
              <button onClick={() => setStep('input')} className="text-xl font-extralight tracking-[0.3em] text-gray-200 hover:text-white transition-colors">
                DRESS CODEs
              </button>
            </div>
            
            {/* é¸ã°ã‚ŒãŸææ¡ˆ - å³ä¸‹å›ºå®š */}
            {okList.length > 0 && (
              <button
                onClick={() => setStep('okList')}
                className="fixed bottom-6 right-6 z-50 px-4 py-2 bg-gray-900 border border-gray-700 text-gray-300 hover:text-white hover:border-gray-500 transition-colors text-sm"
              >
                é¸ã°ã‚ŒãŸææ¡ˆ ({okList.length})
              </button>
            )}
            
            <img 
              src="butler.png" 
              alt="Butler" 
              style={{height: '180px', width: 'auto'}} 
              className="mx-auto mb-6" 
            />
            
            <p className="text-center text-gray-200 mb-8 serif text-lg max-w-4xl mx-auto">
              ãŠå®¢æ§˜ã«ãŠã™ã™ã‚ã®ã‚³ãƒ¼ãƒ‡ã‚£ãƒãƒ¼ãƒˆã¯ã“ã¡ã‚‰ã§ã”ã–ã„ã¾ã™
            </p>
            
            <div className="max-w-4xl mx-auto">
              {/* é¸æŠã—ãŸãƒ‰ãƒ¬ã‚¹ã‚³ãƒ¼ãƒ‰ç”»åƒ */}
              {selectedProposal && selectedProposal.imageUrl && (
                <div className="mb-8">
                  <img 
                    src={selectedProposal.imageUrl} 
                    alt={selectedProposal.title}
                    className="w-full max-w-2xl mx-auto rounded-lg border border-gray-800"
                    style={{maxHeight: '300px', objectFit: 'cover'}}
                  />
                </div>
              )}
              
              <div className="mb-8">
                <h2 className="text-3xl font-light tracking-wide mb-2">{selectedProposal.title}</h2>
                <p className="text-base text-gray-300 serif">
                  {partyInfo.userGender} / {partyInfo.ageGroup} / äºˆç®—: {partyInfo.budget}
                </p>
              </div>

              <div className="bg-gray-950 border border-gray-900 p-8 mb-8 serif">
                <div 
                  className="text-gray-300 leading-relaxed"
                  dangerouslySetInnerHTML={{
                    __html: outfit.content
                      .replace(/\*\*([^*]+)\*\*/g, '$1')  // **å¤ªå­—** â†’ å¤ªå­—
                      .replace(/_([^_]+)_/g, '$1')  // _ã‚¤ã‚¿ãƒªãƒƒã‚¯_ â†’ ã‚¤ã‚¿ãƒªãƒƒã‚¯
                      .replace(/ï¿½ï¿½/g, '')  // æ–‡å­—åŒ–ã‘å‰Šé™¤
                      .replace(/## ([^\n]+)/g, '<h3 class="text-lg font-light mt-6 mb-3 text-white border-b border-gray-800 pb-2">$1</h3>')
                      .replace(/ãƒ»([^\n]+)/g, '<div class="ml-4 mb-2">ãƒ»$1</div>')
                      .replace(/\n\n/g, '<br/><br/>')
                  }}
                />
              </div>

              {outfit.items && outfit.items.length > 0 && (
                <div className="bg-gray-950 border border-gray-900 p-8 mb-8">
                  <h3 className="text-lg font-light mb-4 tracking-wide">è³¼å…¥å…ˆãƒªãƒ³ã‚¯</h3>
                  <div className="space-y-3">
                    {outfit.items.map((item, index) => {
                      const searchKeyword = `${selectedProposal.title} ${item}`;
                      return (
                        <div key={index} className="text-sm text-gray-200 serif">
                          <span className="text-gray-200">{item}:</span>
                          <div className="mt-1 flex gap-4 flex-wrap">
                            <a
                              href={`https://www.google.com/search?q=${encodeURIComponent(searchKeyword)}&tbm=isch`}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="text-gray-300 hover:text-white transition-colors"
                            >
                              ğŸ–¼ï¸ Googleç”»åƒ
                            </a>
                            <a
                              href={`https://www.amazon.co.jp/s?k=${encodeURIComponent(searchKeyword)}`}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="text-gray-300 hover:text-white transition-colors"
                            >
                              ğŸ›ï¸ Amazon
                            </a>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}

              <div className="flex gap-4 justify-center">
                <button
                  onClick={() => setStep('selection')}
                  className="px-8 py-3 border border-gray-800 text-gray-200 hover:text-white hover:border-gray-600 transition-all"
                >
                  ãƒ‰ãƒ¬ã‚¹ã‚³ãƒ¼ãƒ‰é¸æŠã«æˆ»ã‚‹
                </button>
                <button
                  onClick={reset}
                  className="px-6 py-3 border border-gray-800 text-gray-200 hover:text-white hover:border-gray-600 transition-all"
                >
                  æœ€åˆã‹ã‚‰
                </button>
                <button
                  onClick={handleOkClick}
                  className="px-8 py-3 bg-white text-black hover:bg-gray-200 transition-all font-semibold"
                >
                  OK
                </button>
              </div>
              
              {/* è©•ä¾¡ãƒ¢ãƒ¼ãƒ€ãƒ« */}
              {showRatingModal && (
                <div className="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-6 z-50">
                  <div className="bg-gray-950 border border-gray-800 p-8 max-w-md w-full">
                    <h3 className="text-2xl font-light mb-6 text-center">ã“ã®ã‚³ãƒ¼ãƒ‡ã‚£ãƒãƒ¼ãƒˆã‚’è©•ä¾¡ã—ã¦ãã ã•ã„</h3>
                    
                    <div className="mb-6">
                      <div className="flex justify-center gap-2 mb-4">
                        {[1, 2, 3, 4, 5].map(rating => (
                          <button
                            key={rating}
                            onClick={() => setCurrentRating(rating)}
                            className="text-4xl transition-all hover:scale-110"
                          >
                            {rating <= currentRating ? 'â˜…' : 'â˜†'}
                          </button>
                        ))}
                      </div>
                      <p className="text-center text-sm text-gray-200">
                        {currentRating === 0 ? 'è©•ä¾¡ã‚’é¸æŠã—ã¦ãã ã•ã„' : `${currentRating}ã¤æ˜Ÿ`}
                      </p>
                    </div>
                    
                    <div className="mb-6">
                      <label className="block text-sm text-gray-200 mb-2">ä¸€è¨€ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
                      <textarea
                        value={currentComment}
                        onChange={(e) => setCurrentComment(e.target.value)}
                        placeholder="å®Ÿç¾ã§ããã†ï¼é€±æœ«ã‚„ã£ã¦ã¿ã‚‹"
                        className="w-full bg-gray-900 border border-gray-700 p-3 text-sm rounded focus:border-white focus:outline-none"
                        rows="3"
                      />
                    </div>
                    
                    <div className="flex gap-4">
                      <button
                        onClick={() => {
                          setShowRatingModal(false);
                          setCurrentRating(0);
                          setCurrentComment('');
                        }}
                        className="flex-1 px-6 py-3 border border-gray-800 text-gray-200 hover:text-white hover:border-gray-600 transition-all"
                      >
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                      </button>
                      <button
                        onClick={handleSaveRating}
                        className="flex-1 px-6 py-3 bg-white text-black hover:bg-gray-200 transition-all font-semibold"
                      >
                        ä¿å­˜ã™ã‚‹
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      }
      
      // OKãƒªã‚¹ãƒˆãƒšãƒ¼ã‚¸
      if (step === 'okList') {
        return (
          <div className="min-h-screen bg-black text-white p-6 py-12">
            <div className="fixed top-6 left-6 z-50">
              <h2 className="text-xl font-extralight tracking-[0.3em] text-gray-200">DRESS CODEs</h2>
            </div>
            
            <div className="max-w-6xl mx-auto">
              <div className="flex justify-between items-center mb-8">
                <h2 className="text-3xl font-light">é¸ã°ã‚ŒãŸææ¡ˆ</h2>
                <button
                  onClick={reset}
                  className="px-6 py-2 border border-gray-800 text-gray-200 hover:text-white hover:border-gray-600 transition-all"
                >
                  æœ€åˆã‹ã‚‰
                </button>
              </div>
              
              {okList.length === 0 ? (
                <div className="text-center text-gray-200 py-20">
                  <p className="text-lg">ã¾ã é¸ã°ã‚ŒãŸææ¡ˆã¯ã‚ã‚Šã¾ã›ã‚“</p>
                  <button
                    onClick={reset}
                    className="mt-8 px-8 py-3 bg-white text-black hover:bg-gray-200 transition-all"
                  >
                    ææ¡ˆã‚’å—ã‘ã‚‹
                  </button>
                </div>
              ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                  {okList.map(entry => (
                    <button
                      key={entry.id}
                      onClick={() => setSelectedOkEntry(entry)}
                      className="bg-gray-950 border border-gray-900 overflow-hidden hover:border-gray-200 transition-all text-left"
                    >
                      <img
                        src={entry.imageUrl}
                        alt={entry.dressCode}
                        className="w-full h-48 object-cover"
                      />
                      <div className="p-6">
                        <h3 className="text-lg font-light mb-2">{entry.dressCode}</h3>
                        <div className="flex items-center gap-2 mb-3">
                          <div className="text-yellow-500">
                            {'â˜…'.repeat(entry.rating)}{'â˜†'.repeat(5 - entry.rating)}
                          </div>
                          <span className="text-sm text-gray-200">({entry.rating})</span>
                        </div>
                        {entry.comment && (
                          <p className="text-sm text-gray-200 italic mb-3">ã€Œ{entry.comment}ã€</p>
                        )}
                        <p className="text-xs text-gray-200">
                          {new Date(entry.timestamp).toLocaleDateString('ja-JP')}
                        </p>
                      </div>
                    </button>
                  ))}
                </div>
              )}
              
              {/* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—: ææ¡ˆæ–‡è¡¨ç¤º */}
              {selectedOkEntry && (
                <div className="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-6 z-50" onClick={() => setSelectedOkEntry(null)}>
                  <div className="bg-gray-950 border border-gray-800 p-8 max-w-4xl w-full max-h-[80vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                    <div className="flex justify-between items-start mb-6">
                      <div>
                        <h2 className="text-3xl font-light mb-2">{selectedOkEntry.dressCode}</h2>
                        <div className="flex items-center gap-3">
                          <div className="text-yellow-500 text-xl">
                            {'â˜…'.repeat(selectedOkEntry.rating)}{'â˜†'.repeat(5 - selectedOkEntry.rating)}
                          </div>
                          {selectedOkEntry.comment && (
                            <p className="text-gray-200 italic">ã€Œ{selectedOkEntry.comment}ã€</p>
                          )}
                        </div>
                      </div>
                      <button
                        onClick={() => setSelectedOkEntry(null)}
                        className="text-gray-200 hover:text-white text-2xl"
                      >
                        Ã—
                      </button>
                    </div>
                    
                    <img
                      src={selectedOkEntry.imageUrl}
                      alt={selectedOkEntry.dressCode}
                      className="w-full max-h-64 object-cover mb-6 rounded"
                    />
                    
                    <div 
                      className="text-gray-200 leading-relaxed prose prose-invert max-w-none"
                      dangerouslySetInnerHTML={{
                        __html: selectedOkEntry.outfit
                          .replace(/\*\*([^*]+)\*\*/g, '$1')
                          .replace(/_([^_]+)_/g, '$1')
                          .replace(/ï¿½ï¿½/g, '')
                          .replace(/## ([^\n]+)/g, '<h3 class="text-xl font-light mt-6 mb-3 text-white border-b border-gray-800 pb-2">$1</h3>')
                          .replace(/ãƒ»([^\n]+)/g, '<div class="ml-4 mb-2">ãƒ»$1</div>')
                          .replace(/\n\n/g, '<br/><br/>')
                      }}
                    />
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      }

      return null;
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<DressCodes />);
  </script>
</body>
</html>
